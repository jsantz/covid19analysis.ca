
let Application = PIXI.Application,
    Container = PIXI.Container,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Graphics = PIXI.Graphics,
    TextureCache = PIXI.utils.TextureCache,
    Sprite = PIXI.Sprite,
    Text = PIXI.Text,
    TextStyle = PIXI.TextStyle,
    Radius = 10,
    populations = 200,
    naturalImmunity = 1,
    riskpop = 1,
    bump = false,
    transmissibility = 100,
    socialSpeed = 1,
    infectionLength = 300,
    sample = 30,
    timeline = 0,
    healthyset=[],
    immuneset=[],
    infectedset=[],
    xvals =[];

let state, explorer, infected, healthy, chimes, exit, player, dungeon,
    immune, healthBar, message, gameScene, gameOverScene, enemies, id;

//Create a Pixi Application
let app = new Application({
    width: 710,
    height: 710,
    antialiasing: true,
    transparent: false,
    resolution: 1
});

function renderScene(){
    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);
    loader.add("images/pandemic.json");
    loader.load(setup);


}
function setup() {
    gameScene = new Container();
    app.stage.addChild(gameScene);
    id = resources["images/pandemic.json"].textures;
    //Dungeon
    dungeon = new Sprite(id["area.png"]);
    gameScene.addChild(dungeon);


    //Explorer
    explorer = new Sprite(id["explorer.png"]);
    explorer.x = 68;
    explorer.y = gameScene.height / 2 - explorer.height / 2;
    explorer.vx = 0;
    explorer.vy = 0;
    //gameScene.addChild(explorer);

    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

    Create The Sprites

    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

    // set pops
    let spacing = 2,
        xOffset = 150,
        speed = socialSpeed,
        direction = 3;

    //immune
    immunes = [];
    let numberOfImmune = naturalImmunity;
    for (let i = 0; i < numberOfImmune; i++) {
        //Make an infected
        immune = new Sprite(id["immune.png"]);
        let x = randomInt(0, app.stage.width - immune.width);
        let y = randomInt(0, app.stage.height - immune.height);
        immune.x = x;
        immune.y = y;
        immune.vy = speed * randomInt(-3, 3);
        immune.vx = speed * randomInt(-3, 3);
        direction *= -1;
        immunes.push(immune);
        gameScene.addChild(immune);
    }

    //make the infected
    let numberOfInfected = riskpop;
    infecteds = [];
    for (let i = 0; i < numberOfInfected; i++) {
        //Make an infected
        infected = new Sprite(id["infected.png"]);
        let x = randomInt(0, app.stage.width - infected.width);
        let y = randomInt(0, app.stage.height - infected.height);
        infected.x = x;
        infected.y = y;
        infected.vy = speed * randomInt(-3, 3);
        infected.vx = speed * randomInt(-3, 3);
        infected.infection=infectionLength;
        direction *= -1;
        infecteds.push(infected);
        gameScene.addChild(infected);
    }
    /*infected = new Sprite(id["infected.png"]);
    infected.x = gameScene.width - infected.width - 48;
    infected.y = gameScene.height / 2 - infected.height / 2;
    gameScene.addChild(infected);*/

    //Make the healthy
    let numberOfHealthy = populations;

    //An array to store all the healthy people
    healthys = [];
    for (let i = 0; i < numberOfHealthy; i++) {
        //Make a healthy
        let healthy = new Sprite(id["healthy.png"]);
        let x = randomInt(0, 700 - healthy.width);
        let y = randomInt(0, 700 - healthy.height);
        healthy.x = x;
        healthy.y = y;
        healthy.vy = speed * randomInt(-3, 3);
        healthy.vx = speed * randomInt(-3, 3);
        direction *= -1;
        healthys.push(healthy);
        gameScene.addChild(healthy);
    }

    //Create the `gameOver` scene
    gameOverScene = new Container();
    app.stage.addChild(gameOverScene);

    //Make the `gameOver` scene invisible when the game first starts
    gameOverScene.visible = false;

    //Create the text sprite and add it to the `gameOver` scene
    let style = new TextStyle({
        fontFamily: "Futura",
        fontSize: 64,
        fill: "white"
    });

    //message = new Text("The End!", style);
    //message.x = 120;
    //message.y = app.stage.height / 2 - 32;
    //fgameOverScene.addChild(message);
    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

    Capture The Keyboard

    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
    /*Capture the keyboard arrow keys
    let left = keyboard(37),
        up = keyboard(38),
        right = keyboard(39),
        down = keyboard(40);
    //Left arrow key `press` method
    left.press = function() {

        //Change the explorer's velocity when the key is pressed
        explorer.vx = -5;
        explorer.vy = 0;
    };
    //Left arrow key `release` method
    left.release = function() {

        //If the left arrow has been released, and the right arrow isn't down,
        //and the explorer isn't moving vertically:
        //Stop the explorer
        if (!right.isDown && explorer.vy === 0) {
            explorer.vx = 0;
        }
    };
    //Up
    up.press = function() {
        explorer.vy = -5;
        explorer.vx = 0;
    };
    up.release = function() {
        if (!down.isDown && explorer.vx === 0) {
            explorer.vy = 0;
        }
    };
    //Right
    right.press = function() {
        explorer.vx = 5;
        explorer.vy = 0;
    };
    right.release = function() {
        if (!left.isDown && explorer.vy === 0) {
            explorer.vx = 0;
        }
    };
    //Down
    down.press = function() {
        explorer.vy = 5;
        explorer.vx = 0;
    };
    down.release = function() {
        if (!up.isDown && explorer.vx === 0) {
            explorer.vy = 0;
        }
    };
    //Set the game state*/
    state = play;
    //Start the game loop
    app.ticker.add(delta => gameLoop(delta));
}
function gameLoop(delta){

    //Update the current game state:
    state(delta);
}
function play(delta) {
    sample--;

    //use the explorer's velocity to make it move
    explorer.x += explorer.vx;
    explorer.y += explorer.vy;

    //Contain the explorer inside the area of the dungeon
    contain(explorer, {x: 28, y: 10, width: 700, height: 700});
    //contain(explorer, stage);

    //Set `explorerHit` to `false` before checking for a collision
    let explorerHit = false;

    //Loop through healthies
    healthys.forEach(function(healthy) {
        healthy.y += healthy.vy;
        healthy.x += healthy.vx;
        let healthHitsWall = contain(healthy, {x: 28, y: 10, width: 700, height: 700});
        if (healthHitsWall === "top" || healthHitsWall === "bottom" ) {
            healthy.vy *= -1;
        }
        if(healthHitsWall==="left" ||healthHitsWall==="right"){
            healthy.vx *= -1;
        }
        /*if(hitTestRectangle(explorer, healthy, Radius)) {
            explorerHit = true;
        }*/
        healthys.forEach(function(healthy1){
            if(hitTestRectangle(healthy, healthy1, Radius)){
                if(bump){
                    healthy.vx *= -1;
                    healthy.vy *= -1;
                    healthy1.vx *= -1;
                    healthy1.vy *= -1;
                }
            }
        });
    });

    //Loop through infecteds
    infecteds.forEach(function(infected, infdex, infset ) {
        infected.y += infected.vy;
        infected.x += infected.vx;
        let healthHitsWall = contain(infected, {x: 28, y: 10, width: 700, height: 700});
        if (healthHitsWall === "top" || healthHitsWall === "bottom" ) {
            infected.vy *= -1;
        }
        if(healthHitsWall==="left" ||healthHitsWall==="right"){
            infected.vx *= -1;
        }
        /*if(hitTestRectangle(explorer, healthy, Radius)) {
            explorerHit = true;
        }*/
        healthys.forEach(function(healthy, index, set){
            if(hitTestRectangle(infected, healthy, Radius)){
                let isInfected = transmission();
                let infectedn;
                if(isInfected){
                    infectedn = new Sprite(id["infected.png"]);
                    infectedn.x = healthy.x;
                    infectedn.y = healthy.y;
                    infectedn.vy = healthy.vy;
                    infectedn.vx = healthy.vx;
                    infectedn.infection=infectionLength;
                    infecteds.push(infectedn);
                    set.splice(index, 1);
                    gameScene.addChild(infectedn);
                    gameScene.removeChild(healthy);
                }
                if(bump){
                    infected.vx *= -1;
                    infected.vy *= -1;
                    healthy.vx *= -1;
                    healthy.vy *= -1;
                }
                healtys = set;
            }
        });
        infected.infection--;
        if(!infected.infection){
            let immune;
            immune = new Sprite(id["immune.png"]);
            immune.x = infected.x;
            immune.y = infected.y;
            immune.vy = infected.vy;
            immune.vx = infected.vx;
            immune.infection=30;
            immunes.push(immune);
            infset.splice(infdex, 1);
            gameScene.addChild(immune);
            gameScene.removeChild(infected);
        }
        infecteds = infset;
    });

    immunes.forEach(function(immune) {
        immune.y += immune.vy;
        immune.x += immune.vx;
        let healthHitsWall = contain(immune, {x: 28, y: 10, width: 700, height: 700});
        if (healthHitsWall === "top" || healthHitsWall === "bottom" ) {
            immune.vy *= -1;
        }
        if(healthHitsWall==="left" ||healthHitsWall==="right"){
            immune.vx *= -1;
        }
        /*if(hitTestRectangle(explorer, healthy, Radius)) {
            explorerHit = true;
        }*/
        immunes.forEach(function(immune1){
            if(hitTestRectangle(immune, immune1, Radius)){
                if(bump){
                    immune.vx *= -1;
                    immune.vy *= -1;
                    immune1.vx *= -1;
                    immune1.vy *= -1;
                }
            }
        });
    });

    //If the explorer is hit...
    if(explorerHit) {

        //Make the explorer semi-transparent
        explorer.alpha = 0.5;

        //Reduce the width of the health bar's inner rectangle by 1 pixel
        healthBar.outer.width -= 1;

    } else {

        //Make the explorer fully opaque (non-transparent) if it hasn't been hit
        explorer.alpha = 1;
    }

    //Check for a collision between the explorer and the infected
    if (hitTestRectangle(explorer, infected, Radius)) {
        //If the infected is touching the explorer, center it over the explorer
        infected.x = explorer.x + 8;
        infected.y = explorer.y + 8;
    }

    if (infecteds.length == 0) {
        state = end;
        //message.text = "You won!";
    }
    if(!sample){
        sample=30;
        healthyset[timeline]= { t: timeline, y: healthys.length};
        infectedset[timeline] = { t: timeline, y: infecteds.length};
        immuneset[timeline] = { t: timeline, y: immunes.length};
        xvals[timeline]=timeline;
        //var ctx = document.getElementById('canvas').getContext('2d');
        //window.myLine = new Chart(ctx, config);
        window.myLine.update();
        timeline++;
    }
}
function end() {
    //gameScene.visible = false;
    //gameOverScene.visible = true;
}
function transmission(){
    let fraction = 100/transmissibility;
    let testFraction = randomInt(0,fraction);
    if (testFraction < 1){
        return true;
    }else{
        return false;
    }


}
function contain(sprite, container) {
    let collision = undefined;
    if (sprite.x < container.x) {
        sprite.x = container.x;
        collision = "left";
    }
    if (sprite.y < container.y) {
        sprite.y = container.y;
        collision = "top";
    }
    if (sprite.x + sprite.width > container.width) {
        sprite.x = container.width - sprite.width;
        collision = "right";
    }
    if (sprite.y + sprite.height > container.height) {
        sprite.y = container.height - sprite.height;
        collision = "bottom";
    }
    return collision;
}
function hitTestRectangle(r1, r2, radius) {
    let hit, combinedHalfWidths, combinedHalfHeights, vx, vy; //dist;
    hit = false;
    r1.centerX = r1.x + r1.width / 2;
    r1.centerY = r1.y + r1.height / 2;
    r2.centerX = r2.x + r2.width / 2;
    r2.centerY = r2.y + r2.height / 2;
    r1.halfWidth = r1.width / 2;
    r1.halfHeight = r1.height / 2;
    r2.halfWidth = r2.width / 2;
    r2.halfHeight = r2.height / 2;
    vx = r1.centerX - r2.centerX;
    vy = r1.centerY - r2.centerY;
    //dist = Math.sqrt(Math.pow(vx,2) + Math.pow(vy,2));
    //hit = dist < radius;
    combinedHalfWidths = radius; //r1.halfWidth + r2.halfWidth;
    combinedHalfHeights = radius; //r1.halfHeight + r2.halfHeight;
    //Check for a collision on the x axis
    if (Math.abs(vx) < combinedHalfWidths) {
        if (Math.abs(vy) < combinedHalfHeights) {
            hit = true;
        } else {
            hit = false;
        }
    } else {
        hit = false;
    }
    return hit;
};
function randomInt(min, max) {
    let temp = Math.random();
    if(temp===0){
        temp=1;
    }
    return Math.floor(temp * (max - min + 1)) + min;
}
function keyboard(keyCode) {
    var key = {};
    key.code = keyCode;
    key.isDown = false;
    key.isUp = true;
    key.press = undefined;
    key.release = undefined;
    //The `downHandler`
    key.downHandler = function(event) {
        if (event.keyCode === key.code) {
            if (key.isUp && key.press) key.press();
            key.isDown = true;
            key.isUp = false;
        }
        event.preventDefault();
    };
    //The `upHandler`
    key.upHandler = function(event) {
        if (event.keyCode === key.code) {
            if (key.isDown && key.release) key.release();
            key.isDown = false;
            key.isUp = true;
        }
        event.preventDefault();
    };
    //Attach event listeners
    window.addEventListener(
        "keydown", key.downHandler.bind(key), false
    );
    window.addEventListener(
        "keyup", key.upHandler.bind(key), false
    );
    return key;
}

renderScene();

var config = {
    type: 'line',
    data: {
        labels: xvals,
        datasets: [
            {
                label: 'Healthy',
                //fill:false,
                borderColor: '#4383cc',
                backgroundColor: '#8ab2df',
                data: healthyset,
            },
            {
                label: 'Infected',
                borderColor: '#FF0000',
                backgroundColor: '#FFaf30',
                data: infectedset,
            },
            {
                label: 'Immune',
                borderColor: '#a4c15b',
                backgroundColor: '#c6d899',
                data: immuneset,
            }
        ]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'Population Changes'
        },
        tooltips: {
            mode: 'index',
        },
        hover: {
            mode: 'index'
        },
        scales: {
            xAxes: [{
                distribution: 'series',
                offset: true,
                labelString: 'Epoch',
                ticks: {
                    major: {
                        enabled: true,
                        fontStyle: 'bold'
                    },
                    source: 'data',
                    autoSkip: true,
                    autoSkipPadding: 75,
                    maxRotation: 0,
                    sampleSize: 100
                }
            }],
            yAxes: [{
                stacked: false,
                scaleLabel: {
                    display: true,
                    labelString: 'Population'
                }

            }]
        }
    }
};


window.onload = function() {
    var ctx = document.getElementById('canvas').getContext('2d');
    window.myLine = new Chart(ctx, config);
}
$('#runsimulation').click(function(){

    //RESET NEW VALUES
    populations = $( "#slider-range-min" ).slider( "value" );
    transmissibility = $("#transmissibility").slider("value");
    

    app.destroy(true);
    app = null;
    //loader.resources["images/pandemic.json"].texture.destroy(true);
    loader.reset();
    app = new Application({
        width: 710,
        height: 710,
        antialiasing: true,
        transparent: false,
        resolution: 1
    });

    healthyset= [];
    immuneset=[];
    infectedset=[];
    xvals =[];
    timeline = 0;
    var config = {
        type: 'line',
        data: {
            labels: xvals,
            datasets: [
                {
                    label: 'Healthy',
                    //fill:false,
                    borderColor: '#4383cc',
                    backgroundColor: '#8ab2df',
                    data: healthyset,
                },
                {
                    label: 'Infected',
                    borderColor: '#FF0000',
                    backgroundColor: '#FFaf30',
                    data: infectedset,
                },
                {
                    label: 'Immune',
                    borderColor: '#a4c15b',
                    backgroundColor: '#c6d899',
                    data: immuneset,
                }
            ]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Population Changes'
            },
            tooltips: {
                mode: 'index',
            },
            hover: {
                mode: 'index'
            },
            scales: {
                xAxes: [{
                    distribution: 'series',
                    offset: true,
                    labelString: 'Epoch',
                    ticks: {
                        major: {
                            enabled: true,
                            fontStyle: 'bold'
                        },
                        source: 'data',
                        autoSkip: true,
                        autoSkipPadding: 75,
                        maxRotation: 0,
                        sampleSize: 100
                    }
                }],
                yAxes: [{
                    stacked: false,
                    scaleLabel: {
                        display: true,
                        labelString: 'Population'
                    }

                }]
            }
        }
    };
    var ctx = document.getElementById('canvas').getContext('2d');
    window.myLine = new Chart(ctx, config);
    renderScene();
})